/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data while allowing public read access to menu items and order items.
 *
 * Data Structure:
 * - /canteens/{canteenId}: Stores canteen information, secured by ownerId.
 * - /menu_items/{menuItemId}: Publicly readable menu items.
 * - /users/{userId}/cart_items/{cartItemId}: User-specific cart items, secured by path-based ownership.
 * - /users/{userId}/orders/{orderId}: User-specific order history, secured by path-based ownership.
 * - /order_items/{orderItemId}: Publicly readable order items.
 * - /users/{userId}: User profiles, secured by path-based ownership.
 *
 * Key Security Decisions:
 * - User data is strictly segregated under /users/{userId} to enforce ownership.
 * - Menu items are publicly readable.
 * - No user listing is allowed.
 * - All write operations require authentication.
 * - Data validation is limited to critical authorization fields.
 *
 * Denormalization for Authorization:
 * - Ownership is enforced using path-based rules (e.g., /users/{userId}/...) and validated against fields within the documents.
 *
 * Structural Segregation:
 * - Private user data is stored under /users/{userId}, while public data (menu items, order items) resides in top-level collections.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows access to canteen information based on ownership.
     * @path /canteens/{canteenId}
     * @allow (read) Authenticated users can read canteen information.
     * @allow (create) Authenticated user can create a canteen if they are the owner.
     * @allow (update) Authenticated owner can update their canteen.
     * @allow (delete) Authenticated owner can delete their canteen.
     * @deny (create) Unauthenticated user can't create a canteen.
     * @deny (update) Non-owner can't update the canteen.
     * @deny (delete) Non-owner can't delete the canteen.
     * @principle Enforces document ownership for writes.
     */
    match /canteens/{canteenId} {
      function isOwner(ownerId) {
        return request.auth != null && request.auth.uid == ownerId;
      }

      function isExistingOwner(ownerId) {
        return isOwner(ownerId) && resource != null;
      }

      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.ownerId);
      allow delete: if isExistingOwner(resource.data.ownerId);
    }

    /**
     * @description Allows public read access to menu items, and write access for authenticated users.
     * @path /menu_items/{menuItemId}
     * @allow (get, list) Any user can read menu items.
     * @allow (create, update, delete) Authenticated users (admins) can manage menu items.
     * @principle Allows public read and admin write access.
     */
    match /menu_items/{menuItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages cart items for a specific user.
     * @path /users/{userId}/cart_items/{cartItemId}
     * @allow (create) User can create a cart item in their own cart.
     * @allow (get) User can read a cart item in their own cart.
     * @allow (list) User can list cart items in their own cart.
     * @allow (update) User can update a cart item in their own cart.
     * @allow (delete) User can delete a cart item in their own cart.
     * @deny (create) User can't create cart items for other users.
     * @deny (get) User can't read cart items of other users.
     * @deny (list) User can't list cart items of other users.
     * @deny (update) User can't update cart items of other users.
     * @deny (delete) User can't delete cart items of other users.
     * @principle Enforces strict path-based ownership.
     */
    match /users/{userId}/cart_items/{cartItemId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages order history for a specific user.
     * @path /users/{userId}/orders/{orderId}
     * @allow (create) User can create an order in their own order history.
     * @allow (get) User can read an order in their own order history.
     * @allow (list) User can list orders in their own order history.
     * @allow (update) User can update an order in their own order history.
     * @allow (delete) User can delete an order in their own order history.
     * @deny (create) User can't create orders for other users.
     * @deny (get) User can't read orders of other users.
     * @deny (list) User can't list orders of other users.
     * @deny (update) User can't update orders of other users.
     * @deny (delete) User can't delete orders of other users.
     * @principle Enforces strict path-based ownership.
     */
    match /users/{userId}/orders/{orderId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows public read access to order items.
     * @path /order_items/{orderItemId}
     * @allow (get) Any user can read an order item.
     * @allow (list) Any user can list order items.
     * @deny (create) No user can create an order item via the client.
     * @deny (update) No user can update an order item via the client.
     * @deny (delete) No user can delete an order item via the client.
     * @principle Allows public read access with no write access.
     */
    match /order_items/{orderItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages user profiles, enforcing path-based ownership.
     * @path /users/{userId}
     * @allow (create) User can create their own profile.
     * @allow (get) User can read their own profile.
     * @deny (list) No user listing is allowed.
     * @allow (update) User can update their own profile.
     * @allow (delete) User can delete their own profile.
     * @deny (create) User can't create profiles for other users.
     * @deny (get) User can't read profiles of other users.
     * @deny (update) User can't update profiles of other users.
     * @deny (delete) User can't delete profiles of other users.
     * @principle Enforces strict path-based ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    function isSignedIn() {
      return request.auth != null;
    }
  }
}
